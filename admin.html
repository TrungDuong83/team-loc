<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>ADMIN â€“ TEAM Lá»˜C</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;background:#7A0C0C;color:#FFD966}
.box{max-width:1100px;margin:auto;padding:24px}
h1,h2{color:#FFD966}
input,button,select{padding:8px;margin:4px}
button{background:#FFD966;border:none;font-weight:bold;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px}
td,th{border:1px solid #FFD966;padding:6px;color:#fff}
.icon{cursor:pointer;margin:0 6px}
.hidden{display:none}
</style>
</head>

<body>
<div class="box" id="loginBox">
  <h1>ğŸ” ADMIN LOGIN</h1>
  <input id="pass" type="password" placeholder="Máº­t kháº©u">
  <button onclick="login()">ÄÄƒng nháº­p</button>
</div>

<div class="box hidden" id="adminBox">

<h2>ğŸ§¹ RESET LÆ¯á»¢T CHÆ I</h2>
<button onclick="resetAll()">RESET</button>

<hr>

<h2>ğŸª‘ Cáº¤U HÃŒNH BÃ€N</h2>
<input id="teamId" placeholder="MÃ£ bÃ n" disabled>
<input id="teamName" placeholder="TÃªn bÃ n">
<input id="teamSize" type="number" placeholder="Sá»‘ ngÆ°á»i">
<button onclick="saveTeam()">LÆ°u</button>

<table>
<thead>
<tr><th>TÃªn bÃ n</th><th>QR Link</th><th>QR</th><th>Thao tÃ¡c</th></tr>
</thead>
<tbody id="teamTable"></tbody>
</table>

<hr>

<h2>ğŸ GIáº¢I THÆ¯á»NG</h2>
<input id="rewardKey" disabled>
<input id="rTitle" placeholder="TÃªn giáº£i">
<input id="rContent" placeholder="Ná»™i dung">
<input id="rWeight" type="number" placeholder="Weight">
<button onclick="saveReward()">LÆ°u</button>

<table>
<thead>
<tr><th>TÃªn</th><th>Ná»™i dung</th><th>Weight</th><th>Thao tÃ¡c</th></tr>
</thead>
<tbody id="rewardTable"></tbody>
</table>

</div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script type="module">
import { db } from "./firebase.js";
import { ref, set, onValue, remove } from
 "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const ADMIN_PASS="YEP2026";
const PREFIX="TEAMLOC", SALT="2026";

/* LOGIN */
window.login=()=>{
  if(pass.value===ADMIN_PASS){
    loginBox.classList.add("hidden");
    adminBox.classList.remove("hidden");
  } else alert("Sai máº­t kháº©u");
};

/* RESET */
window.resetAll=async()=>{
  await remove(ref(db,"teams"));
  await remove(ref(db,"runtime"));
  alert("ÄÃ£ reset lÆ°á»£t chÆ¡i");
};

/* TEAMS */
window.saveTeam=async()=>{
  const id = teamId.value || Date.now();
  const raw = `${PREFIX}|${id}|${SALT}`;
  const token = btoa(raw);
  const link = `${location.origin}/join.html#k=${token}`;

  await set(ref(db,`config/teams/${id}`),{
    name: teamName.value,
    defaultSize: Number(teamSize.value),
    qrToken: token,
    qrLink: link
  });

  teamId.value=""; teamName.value=""; teamSize.value="";
};

onValue(ref(db,"config/teams"),snap=>{
  teamTable.innerHTML="";
  Object.entries(snap.val()||{}).forEach(([id,t])=>{
    teamTable.innerHTML+=`
    <tr>
      <td>${t.name}</td>
      <td><input value="${t.qrLink||''}" readonly></td>
      <td><div id="qr_${id}"></div></td>
      <td>
        <span class="icon" onclick="editTeam('${id}')">âœï¸</span>
        <span class="icon" onclick="delTeam('${id}')">ğŸ—‘</span>
      </td>
    </tr>`;
    if(t.qrLink){
      new QRCode(document.getElementById(`qr_${id}`),{text:t.qrLink,width:80,height:80});
    }
  });
});

window.editTeam=id=>{
  onValue(ref(db,`config/teams/${id}`),s=>{
    const t=s.val();
    teamId.value=id;
    teamName.value=t.name;
    teamSize.value=t.defaultSize;
  },{onlyOnce:true});
};
window.delTeam=id=>remove(ref(db,`config/teams/${id}`));

/* REWARDS */
window.saveReward=async()=>{
  const k = rewardKey.value || Date.now();
  await set(ref(db,`config/rewards/${k}`),{
    title:rTitle.value,
    content:rContent.value,
    weight:Number(rWeight.value)
  });
  rewardKey.value=""; rTitle.value=""; rContent.value=""; rWeight.value="";
};

onValue(ref(db,"config/rewards"),snap=>{
  rewardTable.innerHTML="";
  Object.entries(snap.val()||{}).forEach(([k,r])=>{
    rewardTable.innerHTML+=`
    <tr>
      <td>${r.title}</td>
      <td>${r.content}</td>
      <td>${r.weight}</td>
      <td>
        <span class="icon" onclick="editReward('${k}')">âœï¸</span>
        <span class="icon" onclick="delReward('${k}')">ğŸ—‘</span>
      </td>
    </tr>`;
  });
});

window.editReward=k=>{
  onValue(ref(db,`config/rewards/${k}`),s=>{
    const r=s.val();
    rewardKey.value=k;
    rTitle.value=r.title;
    rContent.value=r.content;
    rWeight.value=r.weight;
  },{onlyOnce:true});
};
window.delReward=k=>remove(ref(db,`config/rewards/${k}`));
</script>
</body>
</html>
