<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>ADMIN ‚Äì TEAM L·ªòC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  margin:0;font-family:Arial;background:#7A0C0C;color:#FFD966
}
.box{
  max-width:900px;margin:auto;padding:24px
}
h1,h2{color:#FFD966}
input,button,select{padding:10px;margin:6px}
button{background:#FFD966;border:none;font-weight:bold}
.danger{background:#C62828;color:#fff}
table{width:100%;border-collapse:collapse}
td,th{border:1px solid #FFD966;padding:6px;color:#fff}
.hidden{display:none}
</style>
</head>

<body>

<div class="box" id="loginBox">
  <h1>üîê ADMIN LOGIN</h1>
  <input id="pass" type="password" placeholder="M·∫≠t kh·∫©u">
  <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
</div>

<div class="box hidden" id="adminBox">

  <h2>üßπ RESET D·ªÆ LI·ªÜU L∆Ø·ª¢T CH∆†I</h2>
  <p>(Kh√¥ng xo√° c·∫•u h√¨nh b√†n & gi·∫£i th∆∞·ªüng)</p>
  <button class="danger" onclick="resetAll()">RESET L∆Ø·ª¢T CH∆†I</button>

  <hr>

  <h2>ü™ë C·∫§U H√åNH B√ÄN</h2>
  <input id="teamId" placeholder="M√£ b√†n (VD: 1)">
  <input id="teamName" placeholder="T√™n b√†n (VD: B√†n 1)">
  <input id="teamSize" type="number" placeholder="S·ªë ng∆∞·ªùi m·∫∑c ƒë·ªãnh">
  <button onclick="saveTeam()">L∆∞u / C·∫≠p nh·∫≠t</button>

  <table>
    <thead><tr><th>M√£</th><th>T√™n</th><th>S·ªë ng∆∞·ªùi</th><th>Xo√°</th></tr></thead>
    <tbody id="teamList"></tbody>
  </table>

  <hr>

  <h2>üîê T·∫†O QR CHO B√ÄN (M√É HO√Å)</h2>
  <select id="qrTeamSelect"></select>
  <button onclick="generateQR()">T·∫†O QR</button>

  <p><b>Link QR:</b></p>
  <input id="qrLink" style="width:100%" readonly>
  <div id="qrBox" style="margin-top:20px"></div>

  <hr>

  <h2>üéÅ GI·∫¢I TH∆Ø·ªûNG</h2>
  <input id="rTitle" placeholder="T√™n gi·∫£i">
  <input id="rContent" placeholder="N·ªôi dung">
  <input id="rWeight" type="number" placeholder="Weight">
  <button onclick="addReward()">Th√™m</button>

  <table>
    <thead><tr><th>T√™n</th><th>N·ªôi dung</th><th>Weight</th><th>Xo√°</th></tr></thead>
    <tbody id="rewardList"></tbody>
  </table>

</div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script type="module">
import { db } from "./firebase.js";
import { ref, set, onValue, remove } from
 "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const ADMIN_PASS = "YEP2026";
const PREFIX = "TEAMLOC";
const SALT   = "2026";

/* LOGIN */
window.login = ()=>{
  if(pass.value === ADMIN_PASS){
    loginBox.classList.add("hidden");
    adminBox.classList.remove("hidden");
  } else alert("Sai m·∫≠t kh·∫©u");
};

/* RESET L∆Ø·ª¢T CH∆†I */
window.resetAll = async ()=>{
  if(!confirm("Reset d·ªØ li·ªáu l∆∞·ª£t ch∆°i hi·ªán t·∫°i?")) return;
  await remove(ref(db,"teams"));
  await remove(ref(db,"runtime"));
  alert("ƒê√£ reset l∆∞·ª£t ch∆°i");
};

/* SAVE TEAM */
window.saveTeam = async ()=>{
  if(!teamId.value) return alert("Nh·∫≠p m√£ b√†n");
  await set(ref(db,`config/teams/${teamId.value}`),{
    name: teamName.value,
    defaultSize: Number(teamSize.value)
  });
};

/* LOAD TEAMS */
onValue(ref(db,"config/teams"), snap=>{
  teamList.innerHTML="";
  qrTeamSelect.innerHTML="";
  Object.entries(snap.val()||{}).forEach(([id,t])=>{
    teamList.innerHTML+=`
      <tr>
        <td>${id}</td>
        <td>${t.name}</td>
        <td>${t.defaultSize}</td>
        <td><button onclick="delTeam('${id}')">X</button></td>
      </tr>`;
    qrTeamSelect.innerHTML += `<option value="${id}">${t.name}</option>`;
  });
});

window.delTeam = id => remove(ref(db,`config/teams/${id}`));

/* REWARD */
window.addReward = async ()=>{
  const k = Date.now();
  await set(ref(db,`config/rewards/${k}`),{
    title: rTitle.value,
    content: rContent.value,
    weight: Number(rWeight.value)
  });
};

onValue(ref(db,"config/rewards"), snap=>{
  rewardList.innerHTML="";
  Object.entries(snap.val()||{}).forEach(([k,r])=>{
    rewardList.innerHTML+=`
      <tr>
        <td>${r.title}</td>
        <td>${r.content}</td>
        <td>${r.weight}</td>
        <td><button onclick="delReward('${k}')">X</button></td>
      </tr>`;
  });
});

window.delReward = k => remove(ref(db,`config/rewards/${k}`));

/* GENERATE QR */
window.generateQR = ()=>{
  const teamIdVal = qrTeamSelect.value;
  if(!teamIdVal) return alert("Ch·ªçn b√†n");

  const raw = `${PREFIX}|${teamIdVal}|${SALT}`;
  const token = btoa(raw);
  const url = `${location.origin}/join.html#k=${token}`;

  qrLink.value = url;
  document.getElementById("qrBox").innerHTML = "";
  new QRCode(document.getElementById("qrBox"),{
    text: url,
    width: 220,
    height: 220
  });
};
</script>

</body>
</html>
