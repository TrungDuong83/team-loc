<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>ADMIN â€“ TEAM Lá»˜C</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#7A0C0C;color:#FFD966}
.box{max-width:1300px;margin:auto;padding:24px}
h1,h2{color:#FFD966}
input,button{padding:8px;margin:4px}
button{background:#FFD966;border:none;font-weight:bold;cursor:pointer}
button.danger{background:#C62828;color:#fff}
table{width:100%;border-collapse:collapse;margin-top:10px}
td,th{border:1px solid #FFD966;padding:6px;color:#fff;text-align:center}
.icon{cursor:pointer;margin:0 6px;font-size:18px}
.hidden{display:none}
.qr-cell{width:90px}
.state.waiting{color:#FFD966}
.state.enabled{color:#00E676}
.state.counting{color:#29B6F6}
.state.revealed{color:#FFEE58}
.state.locked{color:#EF5350}

/* Modal */
.modal{
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.6);
  align-items:center;
  justify-content:center;
  display:none;
}
.modal.show{
  display:flex;
}

.modal-content{
  background:#5C0A0A;
  padding:20px;
  border-radius:12px;
  min-width:300px;
}
</style>
</head>

<body>

<div class="box" id="loginBox">
  <h1>ğŸ” ADMIN LOGIN</h1>
  <input id="pass" type="password" placeholder="Máº­t kháº©u">
  <button onclick="login()">ÄÄƒng nháº­p</button>
</div>

<div class="box hidden" id="adminBox">

<h2>ğŸ§¹ RESET LÆ¯á»¢T CHÆ I</h2>
<button class="danger" onclick="resetAll()">RESET LÆ¯á»¢T CHÆ I</button>

<hr>

<h2>ğŸª‘ QUáº¢N LÃ BÃ€N</h2>

<input id="teamId" disabled placeholder="ID">
<input id="teamName" placeholder="TÃªn bÃ n">
<input id="teamSize" type="number" placeholder="Sá»‘ ngÆ°á»i">
<button onclick="saveTeam()">LÆ°u</button>

<table>
<thead>
<tr>
  <th>TÃªn bÃ n</th>
  <th>Tráº¡ng thÃ¡i</th>
  <th>Link QR</th>
  <th>QR</th>
  <th>ThÃ nh viÃªn</th>
  <th>Thao tÃ¡c</th>
</tr>
</thead>
<tbody id="teamTable"></tbody>
</table>

<hr>

<h2>ğŸ GIáº¢I THÆ¯á»NG</h2>

<input id="rewardKey" disabled placeholder="Key">
<input id="rTitle" placeholder="TÃªn giáº£i">
<input id="rContent" placeholder="Ná»™i dung">
<input id="rWeight" type="number" placeholder="Weight">
<button onclick="saveReward()">LÆ°u</button>

<table>
<thead>
<tr>
  <th>TÃªn</th><th>Ná»™i dung</th><th>Weight</th><th>Thao tÃ¡c</th>
</tr>
</thead>
<tbody id="rewardTable"></tbody>
</table>

</div>

<!-- MODAL MEMBER -->
<div id="memberModal" class="modal">
  <div class="modal-content">
    <h3>ğŸ‘¥ Danh sÃ¡ch thÃ nh viÃªn</h3>
    <ul id="memberList"></ul>
    <button onclick="closeModal()">ÄÃ³ng</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script type="module">
import { db } from "./firebase.js";
import { ref, set, onValue, remove, get } from
 "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const ADMIN_PASS="YEP2026";
const PREFIX="TEAMLOC", SALT="2026";

/* LOGIN */
window.login=()=>{
  if(pass.value===ADMIN_PASS){
    loginBox.classList.add("hidden");
    adminBox.classList.remove("hidden");
  }else alert("Sai máº­t kháº©u");
};

/* RESET */
window.resetAll=async()=>{
  if(!confirm("Reset lÆ°á»£t chÆ¡i hiá»‡n táº¡i?")) return;
  await remove(ref(db,"teams"));
  await remove(ref(db,"runtime"));
  alert("ÄÃ£ reset");
};

/* SAVE TEAM */
window.saveTeam=async()=>{
  const id = teamId.value || Date.now().toString();
  const raw=`${PREFIX}|${id}|${SALT}`;
  const token=btoa(raw);
  const link=`${location.origin}/join.html#k=${token}`;

  await set(ref(db,`config/teams/${id}`),{
    name:teamName.value,
    defaultSize:Number(teamSize.value),
    qrToken:token,
    qrLink:link
  });

  teamId.value="";teamName.value="";teamSize.value="";
};

/* LOAD TEAMS + STATUS + QR */
onValue(ref(db,"config/teams"), async snap=>{
  teamTable.innerHTML="";
  const runtimeSnap = await get(ref(db,"teams"));
  const runtimeData = runtimeSnap.val() || {};

  const qrQueue=[];

  Object.entries(snap.val()||{}).forEach(([id,t])=>{
    const rt = runtimeData[id] || {};
    const state = rt.state || "waiting";
    const members = rt.members ? Object.values(rt.members) : [];

    teamTable.innerHTML+=`
      <tr>
        <td>${t.name}</td>
        <td class="state ${state}">${state}</td>
        <td><input value="${t.qrLink||''}" readonly style="width:100%"></td>
        <td class="qr-cell"><div id="qr_${id}"></div></td>
        <td>
          ${members.length>0 ? `<span class="icon" onclick="viewMembers('${id}')">ğŸ‘¥ (${members.length})</span>` : "-"}
        </td>
        <td>
          <span class="icon" onclick="editTeam('${id}')">âœï¸</span>
          <span class="icon" onclick="delTeam('${id}')">ğŸ—‘</span>
        </td>
      </tr>`;
    if(t.qrLink) qrQueue.push({id,link:t.qrLink});
  });

  setTimeout(()=>{
    qrQueue.forEach(q=>{
      const el=document.getElementById(`qr_${q.id}`);
      if(el){el.innerHTML="";new QRCode(el,{text:q.link,width:70,height:70});}
    });
  },0);
});

/* VIEW MEMBERS */
window.viewMembers=async(id)=>{
  const snap=await get(ref(db,`teams/${id}/members`));
  const list=snap.val()||{};
  memberList.innerHTML="";
  Object.values(list).forEach(n=>{
    memberList.innerHTML+=`<li>${n}</li>`;
  });
  memberModal.classList.add("show");
};
window.closeModal = ()=>{
  memberModal.classList.remove("show");
};

/* EDIT / DELETE TEAM */
window.editTeam=id=>{
  onValue(ref(db,`config/teams/${id}`),s=>{
    const t=s.val();
    teamId.value=id;teamName.value=t.name;teamSize.value=t.defaultSize;
  },{onlyOnce:true});
};
window.delTeam=id=>remove(ref(db,`config/teams/${id}`));

/* REWARD */
window.saveReward=async()=>{
  const k=rewardKey.value||Date.now().toString();
  await set(ref(db,`config/rewards/${k}`),{
    title:rTitle.value,content:rContent.value,weight:Number(rWeight.value)
  });
  rewardKey.value="";rTitle.value="";rContent.value="";rWeight.value="";
};
onValue(ref(db,"config/rewards"),snap=>{
  rewardTable.innerHTML="";
  Object.entries(snap.val()||{}).forEach(([k,r])=>{
    rewardTable.innerHTML+=`
      <tr>
        <td>${r.title}</td><td>${r.content}</td><td>${r.weight}</td>
        <td>
          <span class="icon" onclick="editReward('${k}')">âœï¸</span>
          <span class="icon" onclick="delReward('${k}')">ğŸ—‘</span>
        </td>
      </tr>`;
  });
});
window.editReward=k=>{
  onValue(ref(db,`config/rewards/${k}`),s=>{
    const r=s.val();
    rewardKey.value=k;rTitle.value=r.title;rContent.value=r.content;rWeight.value=r.weight;
  },{onlyOnce:true});
};
window.delReward=k=>remove(ref(db,`config/rewards/${k}`));
</script>
</body>
</html>
