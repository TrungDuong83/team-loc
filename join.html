<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>TEAM L·ªòC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  min-height:100vh;
  background:radial-gradient(circle at top,#b91c1c,#7a0c0c);
  font-family:Arial;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#FFD966;
}

.card{
  width:90%;
  max-width:420px;
  background:linear-gradient(145deg,#6d0f0f,#3f0707);
  border-radius:24px;
  padding:28px 22px;
  text-align:center;
  box-shadow:0 20px 40px rgba(0,0,0,0.5);
}

h1{
  margin:0 0 18px;
  font-size:30px;
  letter-spacing:1px;
}

.info-box{
  background:rgba(255,255,255,0.08);
  border-radius:16px;
  padding:16px;
  margin-bottom:14px;
  font-size:18px;
  line-height:1.6;
}

.control{
  width:100%;
  margin-top:12px;
}

.control input{
  width:100%;
  height:52px;
  border-radius:16px;
  border:none;
  font-size:18px;
  padding:0 16px;
  box-sizing:border-box;
}

.control button{
  width:100%;
  height:52px;
  margin-top:12px;
  border-radius:16px;
  border:none;
  font-size:20px;
  font-weight:bold;
  background:#FFD966;
  color:#7a0c0c;
  cursor:pointer;
}

.control button:disabled{
  opacity:0.5;
  cursor:not-allowed;
}

.status{
  margin-top:12px;
  font-size:16px;
}
.error{
  color:#ffb4b4;
}
.success{
  color:#b6ffcc;
}
</style>
</head>

<body>

<div class="card">
  <h1>üçÄ TEAM L·ªòC üçÄ</h1>

  <div class="info-box" id="infoBox">
    ƒêang t·∫£i th√¥ng tin b√†n‚Ä¶
  </div>

  <div class="control">
    <input id="nameInput" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
    <button id="joinBtn">H√ÅI L·ªòC</button>
  </div>

  <div class="status" id="status"></div>
</div>

<script type="module">
import { db } from "./firebase.js";
import { ref, get, set, push } from
 "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

/* ===== DOM ===== */
const infoBox  = document.getElementById("infoBox");
const nameInput= document.getElementById("nameInput");
const joinBtn  = document.getElementById("joinBtn");
const statusEl = document.getElementById("status");

/* ===== GET TOKEN ===== */
const token = location.hash.replace("#k=","");
if(!token){
  showError("‚ùå QR kh√¥ng h·ª£p l·ªá");
  joinBtn.disabled = true;
  throw "";
}

let tableId = "";
let tableName = "";

/* ===== INIT ===== */
(async()=>{
  try{
    const decoded = atob(token);
    const [prefix,id,salt] = decoded.split("|");
    if(prefix!=="TEAMLOC") throw "";

    tableId = id;

    /* 1Ô∏è‚É£ L·∫•y b√†n ƒëang m·ªü */
    const activeSnap = await get(ref(db,"runtime/activeTableId"));
    const activeId = activeSnap.val();
    if(!activeId){
      showError("‚è≥ Ch∆∞a ƒë·∫øn l∆∞·ª£t b√†n c·ªßa b·∫°n");
      joinBtn.disabled=true;
      return;
    }

    /* 2Ô∏è‚É£ So s√°nh b√†n */
    if(activeId !== tableId){
      showError("‚ùå B√†n c·ªßa b·∫°n ch∆∞a ƒë∆∞·ª£c m·ªü");
      joinBtn.disabled=true;
      return;
    }

    /* 3Ô∏è‚É£ L·∫•y th√¥ng tin b√†n */
    const teamSnap = await get(ref(db,`config/teams/${tableId}`));
    const team = teamSnap.val();
    if(!team) throw "";

    tableName = team.name;

    /* 4Ô∏è‚É£ L·∫•y runtime b√†n */
    const rtSnap = await get(ref(db,`teams/${tableId}`));
    const rt = rtSnap.val() || {};
    const joined = rt.members ? Object.keys(rt.members).length : 0;
    const total  = rt.total || team.defaultSize;

    infoBox.innerHTML = `
      <div><strong>B√†n s·ªë:</strong> ${tableName}</div>
      <div><strong>Tham gia:</strong> ${joined}/${total}</div>
    `;
  }catch{
    showError("‚ùå QR kh√¥ng h·ª£p l·ªá");
    joinBtn.disabled=true;
  }
})();

/* ===== JOIN ===== */
joinBtn.onclick = async ()=>{
  const name = nameInput.value.trim();
  if(!name){
    showError("Vui l√≤ng nh·∫≠p t√™n");
    return;
  }

  const memberRef = ref(db,`teams/${tableId}/members`);
  await push(memberRef, name);

  showSuccess("üéâ ƒê√£ tham gia Team L·ªôc");
  nameInput.disabled = true;
  joinBtn.disabled = true;
};

/* ===== UTIL ===== */
function showError(msg){
  statusEl.className="status error";
  statusEl.innerText=msg;
}
function showSuccess(msg){
  statusEl.className="status success";
  statusEl.innerText=msg;
}
</script>

</body>
</html>
