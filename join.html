<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>TEAM L·ªòC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  min-height:100vh;
  background:radial-gradient(circle at top,#b91c1c,#7a0c0c);
  font-family:Arial;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#FFD966;
}
.card{
  width:90%;
  max-width:420px;
  background:linear-gradient(145deg,#6d0f0f,#3f0707);
  border-radius:24px;
  padding:28px 22px;
  text-align:center;
  box-shadow:0 20px 40px rgba(0,0,0,0.5);
}
h1{margin:0 0 18px;font-size:30px}

/* INFO BOX ‚Äì R√ï R√ÄNG */
.info-box{
  background:rgba(255,255,255,0.1);
  border-radius:16px;
  padding:18px;
  margin-bottom:16px;
  font-size:20px;
  line-height:1.6;
}
.info-box .label{
  font-weight:bold;
  color:#FFE699;
}

/* CONTROL */
.control input, .control button{
  width:100%;
  height:54px;
  border-radius:16px;
  border:none;
  font-size:18px;
}
.control button{
  margin-top:12px;
  background:#FFD966;
  color:#7a0c0c;
  font-weight:bold;
}
.control button:disabled{
  opacity:0.5;
}

.status{margin-top:12px;font-size:16px}
.error{color:#ffb4b4}
.success{color:#b6ffcc}

/* RESULT POPUP */
.popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10;
}
.popup.show{display:flex}
.popup-content{
  background:#5c0a0a;
  padding:32px;
  border-radius:24px;
  text-align:center;
}
.popup-content h2{
  font-size:30px;
  margin-bottom:14px;
}
.popup-content .reward{
  font-size:26px;
  color:#b6ffcc;
}
</style>
</head>

<body>

<div class="card">
  <h1>üçÄ TEAM L·ªòC üçÄ</h1>

  <div class="info-box" id="infoBox">
    <div><span class="label">B√†n:</span> ‚Äî</div>
    <div><span class="label">Tham gia:</span> ‚Äî</div>
  </div>

  <div class="control">
    <input id="nameInput" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
    <button id="joinBtn">H√ÅI L·ªòC</button>
  </div>

  <div class="status" id="status"></div>
</div>

<!-- RESULT -->
<div id="resultPopup" class="popup">
  <div class="popup-content">
    <h2>üéâ CH√öC M·ª™NG üéâ</h2>
    <div class="reward" id="rewardText"></div>
  </div>
</div>

<script type="module">
import { db } from "./firebase.js";
import { ref, get, push, onValue } from
 "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const infoBox = document.getElementById("infoBox");
const nameInput = document.getElementById("nameInput");
const joinBtn = document.getElementById("joinBtn");
const statusEl = document.getElementById("status");
const popup = document.getElementById("resultPopup");
const rewardText = document.getElementById("rewardText");

const token = location.hash.replace("#k=","");
if(!token) block("‚ùå QR kh√¥ng h·ª£p l·ªá");

let tableId = "";
let joined = false;

/* ===== INIT ===== */
(async()=>{
  try{
    const [prefix,id] = atob(token).split("|");
    if(prefix!=="TEAMLOC") throw "";
    tableId = String(id);

    /* CHECK ACTIVE */
    const activeId = String((await get(ref(db,"runtime/activeTableId"))).val()||"");
    if(activeId !== tableId){
      block("‚è≥ Ch∆∞a ƒë·∫øn l∆∞·ª£t b√†n c·ªßa b·∫°n");
      return;
    }

    /* LOAD TEAM */
    const teamSnap = await get(ref(db,`config/teams/${tableId}`));
    const teamCfg = teamSnap.val();

    const teamRtSnap = await get(ref(db,`teams/${tableId}`));
    const team = teamRtSnap.val() || {};

    renderInfo(teamCfg.name, team);

    /* BLOCK IF REVEALED */
    if(team.state === "revealed"){
      block("üéâ L∆∞·ª£t ch∆°i ƒë√£ k·∫øt th√∫c");
      if(team.result) showResult(team.result);
      return;
    }

    /* LISTEN REALTIME */
    onValue(ref(db,`teams/${tableId}`), snap=>{
      const data = snap.val();
      if(!data) return;

      renderInfo(teamCfg.name, data);

      if(data.state === "revealed"){
        block("üéâ L∆∞·ª£t ch∆°i ƒë√£ k·∫øt th√∫c");
        if(data.result) showResult(data.result);
      }
    });

  }catch{
    block("‚ùå QR kh√¥ng h·ª£p l·ªá");
  }
})();

/* ===== JOIN ===== */
joinBtn.onclick = async ()=>{
  if(joined) return;
  const name = nameInput.value.trim();
  if(!name){showError("Vui l√≤ng nh·∫≠p t√™n");return;}
  await push(ref(db,`teams/${tableId}/members`), name);
  joined = true;
  showSuccess("üéâ ƒê√£ tham gia Team L·ªôc");
  nameInput.disabled=true;
  joinBtn.disabled=true;
};

/* ===== UI ===== */
function renderInfo(name, team){
  const count = team.members ? Object.keys(team.members).length : 0;
  const total = team.total || teamCfg?.defaultSize || 0;
  infoBox.innerHTML = `
    <div><span class="label">B√†n:</span> ${name}</div>
    <div><span class="label">Tham gia:</span> ${count}/${total}</div>
  `;
}
function showResult(r){
  rewardText.innerText = `${r.title} ‚Äì ${r.content}`;
  popup.classList.add("show");
}
function block(msg){
  showError(msg);
  joinBtn.disabled=true;
  nameInput.disabled=true;
}
function showError(msg){
  statusEl.className="status error";
  statusEl.innerText=msg;
}
function showSuccess(msg){
  statusEl.className="status success";
  statusEl.innerText=msg;
}
</script>

</body>
</html>
