<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>TEAM Lá»˜C</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  min-height:100vh;
  background:linear-gradient(135deg,#8E0E00,#1F1C18);
  color:#FFD966;
  font-family:"Segoe UI",Arial;
  display:flex;
  align-items:center;
  justify-content:center;
}

.card{
  width:100%;
  max-width:420px;
  margin:20px;
  padding:32px 28px;
  background:rgba(0,0,0,0.45);
  border-radius:24px;
  box-shadow:0 10px 30px rgba(0,0,0,0.4);
  text-align:center;
}

h1{
  font-size:40px;
  margin-bottom:16px;
}

.info-box{
  background:rgba(255,255,255,0.08);
  border-radius:16px;
  padding:16px 12px;
  margin-bottom:20px;
}

.info-line{
  font-size:22px;
  font-weight:600;
  margin:8px 0;
  color:#FFF3CD;
}

input{
  width:100%;
  padding:16px 18px;
  font-size:20px;
  border-radius:14px;
  border:none;
  outline:none;
  margin-bottom:16px;
  text-align:center;
}

.actions{
  display:flex;
  justify-content:center;
}

button{
  width:100%;
  padding:16px;
  font-size:22px;
  font-weight:700;
  border-radius:16px;
  border:none;
  background:#FFD966;
  color:#7A0C0C;
  cursor:pointer;
}

button:disabled{
  background:#999;
  color:#444;
  cursor:not-allowed;
}

.status{
  margin-top:14px;
  font-size:18px;
  color:#ffffff;
}

.result{
  margin-top:18px;
  font-size:26px;
  font-weight:700;
  color:#00E676;
}
</style>
</head>

<body>
<div class="card">

  <h1>ğŸ€ TEAM Lá»˜C ğŸ€</h1>

  <div class="info-box">
    <div class="info-line" id="teamName">BÃ n: â€”</div>
    <div class="info-line" id="count">Tham gia: â€”</div>
  </div>

  <input id="nameInput" placeholder="Nháº­p tÃªn cá»§a báº¡n">

  <div class="actions">
    <button id="joinBtn" disabled>HÃI Lá»˜C</button>
  </div>

  <div class="status" id="status">â³ Äang chá» MC má»Ÿ bÃ nâ€¦</div>
  <div class="result" id="result"></div>

</div>

<script type="module">
import { db } from "./firebase.js";
import { ref, onValue, push, get } from
  "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

/* ELEMENTS */
const teamNameEl = document.getElementById("teamName");
const countEl    = document.getElementById("count");
const nameInput  = document.getElementById("nameInput");
const joinBtn    = document.getElementById("joinBtn");
const statusEl   = document.getElementById("status");
const resultEl   = document.getElementById("result");

/* STATE */
let activeTeam = null;
let joined = false;

/* THEO DÃ•I BÃ€N ÄANG ACTIVE */
onValue(ref(db,"runtime/activeTeam"), snap=>{
  activeTeam = snap.val();

  if(!activeTeam){
    teamNameEl.innerText = "BÃ n: â€”";
    joinBtn.disabled = true;
    statusEl.innerText = "â³ Äang chá» MC má»Ÿ bÃ nâ€¦";
    return;
  }

  teamNameEl.innerText = `BÃ n sá»‘ ${activeTeam}`;
});

/* THEO DÃ•I TRáº NG THÃI BÃ€N */
onValue(ref(db,"teams"), snap=>{
  if(!activeTeam) return;

  const d = snap.val()?.[activeTeam];
  if(!d){
    countEl.innerText = "Tham gia: 0 / ?";
    joinBtn.disabled = false;
    statusEl.innerText = "ğŸŸ¡ BÃ n Ä‘Ã£ sáºµn sÃ ng";
    return;
  }

  const members = Object.values(d.members||{});
  countEl.innerText = `Tham gia: ${members.length}/${d.expected}`;

  if(d.state === "enabled"){
    joinBtn.disabled = joined;
    statusEl.innerText = "ğŸŸ¢ BÃ n Ä‘ang má»Ÿ â€“ hÃ£y nháº­p tÃªn vÃ  HÃ¡i Lá»™c";
  }else if(d.state === "counting"){
    joinBtn.disabled = true;
    statusEl.innerText = "â±ï¸ Äang Ä‘áº¿m ngÆ°á»£câ€¦";
  }else if(d.state === "revealed"){
    joinBtn.disabled = true;
    statusEl.innerText = "ğŸ‰ ÄÃ£ má»Ÿ lá»™c";
    resultEl.innerHTML = `${d.result.title}<br>${d.result.content}`;
  }else if(d.state === "locked"){
    joinBtn.disabled = true;
    statusEl.innerText = "ğŸ”’ BÃ n Ä‘Ã£ káº¿t thÃºc";
  }
});

/* HÃI Lá»˜C */
joinBtn.onclick = async ()=>{
  if(joined) return;
  if(!activeTeam) return;

  const name = nameInput.value.trim();
  if(!name){
    alert("Vui lÃ²ng nháº­p tÃªn");
    return;
  }

  const teamRef = ref(db,`teams/${activeTeam}`);
  const snap = await get(teamRef);
  const d = snap.val();

  if(d.state !== "enabled"){
    statusEl.innerText = "â›” BÃ n chÆ°a má»Ÿ hoáº·c Ä‘Ã£ Ä‘Ã³ng";
    return;
  }

  const members = Object.values(d.members||{});
  if(members.includes(name)){
    alert("TÃªn Ä‘Ã£ Ä‘Æ°á»£c nháº­p trong bÃ n");
    return;
  }

  await push(ref(db,`teams/${activeTeam}/members`), name);
  joined = true;
  joinBtn.disabled = true;
  statusEl.innerText = "âœ… ÄÃ£ tham gia â€“ chá» má»Ÿ lá»™c";
};
</script>

</body>
</html>
