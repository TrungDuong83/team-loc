<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>MC ‚Äì TEAM L·ªòC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: Arial, sans-serif;
  background:#0A2540;
  color:#fff;
}
h1 { color:#FACC15; font-size:48px }
h2 { font-size:32px }
.count { font-size:28px }
.list li { font-size:24px }
.countdown { font-size:120px; color:#FACC15; text-align:center }
.result { font-size:36px; margin-top:20px }
</style>
</head>

<body>
<h1 id="title"></h1>

<label>S·ªë ng∆∞·ªùi c√≥ m·∫∑t:</label>
<select id="expected">
  <option value="">-- ch·ªçn --</option>
  <option>1</option><option>2</option><option>3</option><option>4</option>
  <option>5</option><option>6</option><option>7</option><option>8</option>
  <option>9</option><option>10</option>
</select>
<button id="open">M·ªû B√ÄN</button>

<div class="count" id="count"></div>
<ul class="list" id="list"></ul>

<div class="countdown" id="countdown"></div>
<div class="result" id="result"></div>

<script type="module">
import { db } from "./firebase.js";
import { ref, onValue, update, get } from
  "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const team = new URLSearchParams(location.search).get("team");
const teamRef = ref(db, `teams/${team}`);
title.innerText = `TEAM L·ªòC ‚Äì B√ÄN ${team}`;

open.onclick = async () => {
  await update(teamRef, {
    expected: Number(expected.value),
    state: "enabled",
    members: {}
  });
};

onValue(teamRef, async snap => {
  const d = snap.val();
  if (!d) return;

  const m = Object.values(d.members || {});
  count.innerText = `ƒê√£ tham gia: ${m.length}/${d.expected || "?"}`;
  list.innerHTML = m.map(x => `<li>${x}</li>`).join("");

  if (d.state === "enabled" && m.length === d.expected) {
    await update(teamRef, { state: "counting" });
    startCountdown();
  }

  if (d.state === "revealed" && d.result) {
    result.innerHTML = `üéâ ${d.result.title} ‚Äì ${d.result.content}`;
  }
});

function startCountdown() {
  let i = 3;
  countdown.innerText = i;
  const t = setInterval(async () => {
    i--;
    countdown.innerText = i || "üçÄ";
    if (i <= 0) {
      clearInterval(t);
      await reveal();
    }
  }, 1000);
}

async function reveal() {
  const snap = await get(ref(db, "config/rewards"));
  const rewards = Object.values(snap.val() || []);
  const pool = [];
  rewards.forEach(r => { for (let i=0;i<r.weight;i++) pool.push(r); });
  const pick = pool[Math.floor(Math.random()*pool.length)];

  await update(teamRef, {
    state: "revealed",
    result: pick
  });
}
</script>
</body>
</html>
