<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>MC ‚Äì TEAM L·ªòC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  margin:0;
  background:radial-gradient(circle,#9B1B1B,#5C0A0A);
  color:#FFD966;
  font-family:"Segoe UI",Arial;
}
.center{max-width:1200px;margin:auto;padding:40px;text-align:center}
h1{font-size:64px;margin:10px}
h2{font-size:36px}
.count{font-size:28px;color:#fff}
ul{list-style:none;padding:0}
li{font-size:26px;color:#fff}
button,select{
  padding:12px 20px;
  font-size:20px;
  background:#FFD966;border:none;font-weight:bold
}
.countdown{font-size:140px;color:#00E676}
.result{font-size:42px;margin-top:20px;color:#00E676}
</style>
</head>
<body>
<div class="center">
  <h1>üçÄ TEAM L·ªòC üçÄ</h1>
  <h2 id="teamTitle">Ch∆∞a ch·ªçn b√†n</h2>

  <select id="teamSelect"></select>
  <select id="expected"></select>
  <button id="open">M·ªû B√ÄN</button>

  <div class="count" id="count"></div>
  <ul id="list"></ul>

  <div class="countdown" id="countdown"></div>
  <div class="result" id="result"></div>
</div>

<script type="module">
import { db } from "./firebase.js";
import { ref,onValue,update,set,get } from
 "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const teamSelect=document.getElementById("teamSelect");
const expected=document.getElementById("expected");
const teamTitle=document.getElementById("teamTitle");

onValue(ref(db,"config/teams"),snap=>{
  teamSelect.innerHTML="<option value=''>--Ch·ªçn b√†n--</option>";
  Object.entries(snap.val()||{}).forEach(([id,t])=>{
    teamSelect.innerHTML+=`<option value="${id}">${t.name}</option>`;
  });
});

teamSelect.onchange=async()=>{
  const id=teamSelect.value;
  if(!id)return;
  await set(ref(db,"runtime/activeTeam"),id);
  const cfg=await get(ref(db,`config/teams/${id}`));
  expected.innerHTML="";
  for(let i=1;i<=cfg.val().defaultSize;i++)
    expected.innerHTML+=`<option>${i}</option>`;
  teamTitle.innerText=`TEAM L·ªòC ‚Äì ${cfg.val().name}`;
};

open.onclick=async()=>{
  const team=(await get(ref(db,"runtime/activeTeam"))).val();
  await update(ref(db,`teams/${team}`),{
    state:"enabled",
    expected:Number(expected.value),
    members:{}
  });
};

onValue(ref(db,"runtime/activeTeam"),snap=>{
  if(!snap.val())return;
  const team=snap.val();
  onValue(ref(db,`teams/${team}`),async s=>{
    const d=s.val(); if(!d)return;
    const m=Object.values(d.members||{});
    count.innerText=`ƒê√£ tham gia: ${m.length}/${d.expected||"?"}`;
    list.innerHTML=m.map(x=>`<li>${x}</li>`).join("");

    if(d.state==="enabled" && m.length===d.expected){
      await update(ref(db,`teams/${team}`),{state:"counting"});
      startCountdown(team);
    }
    if(d.state==="revealed"){
      result.innerHTML=`üéâ ${d.result.title} ‚Äì ${d.result.content}`;
    }
  });
});

function startCountdown(team){
  let i=3; countdown.innerText=i;
  const t=setInterval(async()=>{
    i--; countdown.innerText=i||"üçÄ";
    if(i<=0){
      clearInterval(t);
      const rs=await get(ref(db,"config/rewards"));
      const pool=[];
      Object.values(rs.val()||{}).forEach(r=>{
        for(let j=0;j<r.weight;j++) pool.push(r);
      });
      const pick=pool[Math.floor(Math.random()*pool.length)];
      await update(ref(db,`teams/${team}`),{
        state:"revealed",
        result:pick
      });
    }
  },1000);
}
</script>
</body>
</html>
