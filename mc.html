<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>MC ‚Äì TEAM L·ªòC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  margin:0;
  background:radial-gradient(circle,#9B1B1B,#5C0A0A);
  color:#FFD966;
  font-family:"Segoe UI",Arial;
}
.center{
  max-width:1280px;
  margin:auto;
  padding:40px;
  text-align:center;
}
h1{
  font-size:72px;
  margin:10px 0;
}
h2{
  font-size:40px;
  margin:10px 0;
}
.info{
  font-size:30px;
  color:#fff;
  margin:12px 0;
}
.state{
  font-size:26px;
  margin:10px 0;
}
.state.waiting{color:#FFD966}
.state.enabled{color:#00E676}
.state.counting{color:#29B6F6}
.state.revealed{color:#FFEE58}
.state.locked{color:#EF5350}

ul{
  list-style:none;
  padding:0;
  margin:20px 0;
}
li{
  font-size:28px;
  color:#fff;
}

select, button{
  padding:14px 28px;
  font-size:22px;
  background:#FFD966;
  border:none;
  font-weight:bold;
  cursor:pointer;
  margin:8px;
}
button:disabled{
  background:#999;
  cursor:not-allowed;
}

.countdown{
  font-size:160px;
  color:#00E676;
  margin-top:20px;
}
.result{
  font-size:48px;
  margin-top:20px;
  color:#00E676;
}
</style>
</head>

<body>
<div class="center">

  <h1>üçÄ TEAM L·ªòC üçÄ</h1>

  <!-- CH·ªåN B√ÄN -->
  <select id="teamSelect"></select>

  <h2 id="teamTitle">Ch∆∞a ch·ªçn b√†n</h2>
  <div class="info" id="teamInfo">‚Äî</div>

  <!-- TR·∫†NG TH√ÅI -->
  <div class="state waiting" id="stateLabel">Tr·∫°ng th√°i: Ch·ªù m·ªü</div>

  <!-- N√öT M·ªû B√ÄN -->
  <button id="openBtn" disabled>M·ªû B√ÄN</button>

  <!-- DANH S√ÅCH -->
  <div class="info" id="count"></div>
  <ul id="list"></ul>

  <!-- COUNTDOWN & RESULT -->
  <div class="countdown" id="countdown"></div>
  <div class="result" id="result"></div>

</div>

<script type="module">
import { db } from "./firebase.js";
import { ref, onValue, update, set, get } from
 "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

/* ELEMENTS */
const teamSelect = document.getElementById("teamSelect");
const teamTitle  = document.getElementById("teamTitle");
const teamInfo   = document.getElementById("teamInfo");
const openBtn    = document.getElementById("openBtn");
const stateLabel = document.getElementById("stateLabel");
const countEl    = document.getElementById("count");
const listEl     = document.getElementById("list");
const countdown  = document.getElementById("countdown");
const resultEl   = document.getElementById("result");

/* STATE */
let activeTeam   = null;
let defaultSize  = null;
let currentState = "waiting";

/* LOAD DANH S√ÅCH B√ÄN */
onValue(ref(db,"config/teams"), snap=>{
  teamSelect.innerHTML = "<option value=''>-- Ch·ªçn b√†n --</option>";
  Object.entries(snap.val()||{}).forEach(([id,t])=>{
    teamSelect.innerHTML += `<option value="${id}">${t.name}</option>`;
  });
});

/* MC CH·ªåN B√ÄN */
teamSelect.onchange = async () => {
  const teamId = teamSelect.value;
  resetUI();

  if(!teamId){
    openBtn.disabled = true;
    teamTitle.innerText = "Ch∆∞a ch·ªçn b√†n";
    return;
  }

  const cfgSnap = await get(ref(db,`config/teams/${teamId}`));
  const cfg = cfgSnap.val();

  activeTeam  = teamId;
  defaultSize = cfg.defaultSize;

  teamTitle.innerText = `TEAM L·ªòC ‚Äì ${cfg.name}`;
  teamInfo.innerText  = `S·ªë ng∆∞·ªùi m·∫∑c ƒë·ªãnh: ${defaultSize}`;

  await set(ref(db,"runtime/activeTeam"), teamId);
};

/* M·ªû B√ÄN */
openBtn.onclick = async () => {
  if(currentState !== "waiting") return;
  if(!activeTeam || !defaultSize) return;

  await update(ref(db,`teams/${activeTeam}`),{
    state: "enabled",
    expected: defaultSize,
    members: {}
  });
};

/* THEO D√ïI B√ÄN ƒêANG ACTIVE */
onValue(ref(db,"runtime/activeTeam"), snap=>{
  const teamId = snap.val();
  if(!teamId) return;

  onValue(ref(db,`teams/${teamId}`), async s=>{
    const d = s.val();
    if(!d) return;

    currentState = d.state || "waiting";
    updateStateUI(currentState);

    const members = Object.values(d.members||{});
    countEl.innerText = `ƒê√£ tham gia: ${members.length}/${d.expected}`;
    listEl.innerHTML = members.map(m=>`<li>${m}</li>`).join("");

    /* ƒê·ª¶ NG∆Ø·ªúI ‚Üí COUNTDOWN */
    if(currentState==="enabled" && members.length===d.expected){
      await update(ref(db,`teams/${teamId}`),{state:"counting"});
      startCountdown(teamId);
    }

    /* HI·ªÇN TH·ªä K·∫æT QU·∫¢ */
    if(currentState==="revealed"){
      resultEl.innerHTML = `üéâ ${d.result.title} ‚Äì ${d.result.content}`;
    }
  });
});

/* COUNTDOWN + R√öT L·ªòC */
function startCountdown(teamId){
  let i = 3;
  countdown.innerText = i;

  const t = setInterval(async ()=>{
    i--;
    countdown.innerText = i>0 ? i : "üçÄ";

    if(i<=0){
      clearInterval(t);

      const rs = await get(ref(db,"config/rewards"));
      const pool=[];
      Object.values(rs.val()||{}).forEach(r=>{
        for(let j=0;j<r.weight;j++) pool.push(r);
      });

      const pick = pool[Math.floor(Math.random()*pool.length)];

      await update(ref(db,`teams/${teamId}`),{
        state:"revealed",
        result:pick
      });

      /* T·ª∞ ƒê·ªòNG KH√ìA B√ÄN SAU 5 GI√ÇY */
      setTimeout(async ()=>{
        await update(ref(db,`teams/${teamId}`),{state:"locked"});
      },5000);
    }
  },1000);
}

/* UI STATE */
function updateStateUI(state){
  stateLabel.className = "state " + state;
  const map = {
    waiting  : "Tr·∫°ng th√°i: Ch·ªù m·ªü",
    enabled  : "Tr·∫°ng th√°i: ƒêang nh·∫≠n th√†nh vi√™n",
    counting : "Tr·∫°ng th√°i: ƒê·∫øm ng∆∞·ª£c",
    revealed : "Tr·∫°ng th√°i: ƒê√£ m·ªü l·ªôc",
    locked   : "Tr·∫°ng th√°i: ƒê√£ k·∫øt th√∫c"
  };
  stateLabel.innerText = map[state] || "";

  /* KH√ìA / M·ªû N√öT */
  openBtn.disabled = (state !== "waiting");
}

/* RESET UI KHI ƒê·ªîI B√ÄN */
function resetUI(){
  countEl.innerText = "";
  listEl.innerHTML = "";
  countdown.innerText = "";
  resultEl.innerText = "";
  stateLabel.innerText = "";
  openBtn.disabled = true;
}
</script>
</body>
</html>
