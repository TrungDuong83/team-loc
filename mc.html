<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>MC ‚Äì TEAM L·ªòC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  background:#7a0c0c;
  font-family:Arial;
  color:#FFD966;
}
.container{
  max-width:1400px;
  margin:auto;
  padding:24px;
}
h1,h2{margin:10px 0}

select,button{
  padding:10px;
  font-size:18px;
  margin:6px;
}
button{
  background:#FFD966;
  border:none;
  font-weight:bold;
  cursor:pointer;
}
button:disabled{
  opacity:0.4;
  cursor:not-allowed;
}

/* MEMBER LIST */
.member-list{
  margin-top:20px;
  background:rgba(255,255,255,0.08);
  padding:20px;
  border-radius:16px;
}
.member-list ul{
  list-style:none;
  padding-left:0;
}
.member-list li{
  text-align:left;
  font-size:20px;
  margin:6px 0;
}

/* POPUP */
.popup{
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10;
}
.popup.show{display:flex}
.popup-content{
  background:#5c0a0a;
  padding:40px;
  border-radius:24px;
  text-align:center;
  min-width:420px;
}
.popup-content h2{
  font-size:36px;
}
.countdown{
  font-size:48px;
  margin:20px 0;
}
.result{
  font-size:42px;
  margin-top:20px;
  color:#b6ffcc;
}
</style>
</head>

<body>

<div class="container">

<h1>üé§ MC ‚Äì TEAM L·ªòC</h1>

<div>
  <select id="teamSelect"></select>
  <button id="openBtn">M·ªû B√ÄN</button>
</div>

<h2 id="teamTitle">Ch∆∞a m·ªü b√†n</h2>

<div class="member-list">
  <h3>üë• Danh s√°ch th√†nh vi√™n</h3>
  <ul id="memberList"></ul>
</div>

</div>

<!-- POPUP -->
<div id="popup" class="popup">
  <div class="popup-content">
    <h2>üçÄ TEAM L·ªòC üçÄ</h2>
    <div class="countdown" id="countdown">--</div>
    <div class="result" id="result"></div>
  </div>
</div>

<script type="module">
import { db } from "./firebase.js";
import { ref, get, set, onValue } from
 "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

/* ===== DOM ===== */
const teamSelect = document.getElementById("teamSelect");
const openBtn    = document.getElementById("openBtn");
const teamTitle  = document.getElementById("teamTitle");
const memberList = document.getElementById("memberList");

const popup      = document.getElementById("popup");
const countdownEl= document.getElementById("countdown");
const resultEl   = document.getElementById("result");

/* ===== STATE ===== */
let activeTeamId = "";
let timer = null;
let revealed = false;

/* ===== LOAD TEAMS ===== */
onValue(ref(db,"config/teams"), snap=>{
  teamSelect.innerHTML="";
  Object.entries(snap.val()||{}).forEach(([id,t])=>{
    teamSelect.innerHTML+=`<option value="${id}">${t.name}</option>`;
  });
});

/* ===== OPEN TEAM ===== */
openBtn.onclick = async ()=>{
  const teamId = String(teamSelect.value);
  activeTeamId = teamId;

  const teamSnap = await get(ref(db,`config/teams/${teamId}`));
  const team = teamSnap.val();

  /* l·∫•y th·ªùi gian t·ª´ admin */
  const settingSnap = await get(ref(db,"config/settings/timeLimitSeconds"));
  const limitSec = settingSnap.val() || 30;

  const endTime = Date.now() + limitSec*1000;

  await set(ref(db,"runtime/activeTableId"), teamId);
  await set(ref(db,`teams/${teamId}`),{
    state:"enabled",
    total:team.defaultSize
  });
  await set(ref(db,"runtime/countdownEnd"), endTime);

  teamTitle.innerText = `ƒêang m·ªü: ${team.name}`;
  revealed = false;
  popup.classList.add("show");
};

/* ===== WATCH RUNTIME ===== */
onValue(ref(db,"runtime/countdownEnd"), snap=>{
  if(!snap.val()) return;
  startCountdown(snap.val());
});

/* ===== WATCH MEMBERS ===== */
onValue(ref(db,"teams"), snap=>{
  if(!activeTeamId) return;
  const team = snap.val()?.[activeTeamId];
  if(!team) return;

  const members = team.members ? Object.values(team.members) : [];
  const total = team.total || 0;

  /* render list */
  memberList.innerHTML="";
  members.forEach((m,i)=>{
    memberList.innerHTML+=`<li>${i+1}. ${m}</li>`;
  });

  if(members.length >= total && !revealed){
    revealResult();
  }
});

/* ===== COUNTDOWN ===== */
function startCountdown(endTime){
  clearInterval(timer);
  timer = setInterval(()=>{
    const remain = Math.max(0, Math.ceil((endTime-Date.now())/1000));
    countdownEl.innerText = remain;

    if(remain<=0 && !revealed){
      revealResult();
    }
  },1000);
}

/* ===== REVEAL ===== */
async function revealResult(){
  revealed = true;
  clearInterval(timer);

  const rewardSnap = await get(ref(db,"config/rewards"));
  const rewards = Object.values(rewardSnap.val()||{});
  const reward = rewards[Math.floor(Math.random()*rewards.length)];

  resultEl.innerText = reward.title + " ‚Äì " + reward.content;

  await set(ref(db,`teams/${activeTeamId}/state`),"revealed");
}
</script>

</body>
</html>
