<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>CHUNG TAY H√ÅI L·ªòC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  min-height:100vh;
  background:radial-gradient(circle at top,#b91c1c,#7a0c0c);
  font-family:Arial;
  color:#FFD966;
  display:flex;
  align-items:center;
  justify-content:center;
}

.card{
  width:92%;
  max-width:1300px;
  background:linear-gradient(145deg,#6d0f0f,#3f0707);
  border-radius:28px;
  padding:28px;
  box-shadow:0 25px 50px rgba(0,0,0,0.5);
}

h1{
  text-align:center;
  margin:0 0 20px;
  font-size:42px;
  letter-spacing:1px;
}

.control-bar{
  display:flex;
  justify-content:center;
  gap:12px;
  flex-wrap:wrap;
}

select,button{
  font-size:20px;
  padding:12px 18px;
  border-radius:14px;
  border:none;
}

button{
  background:#FFD966;
  color:#7a0c0c;
  font-weight:bold;
  cursor:pointer;
}
button:disabled{
  opacity:0.5;
  cursor:not-allowed;
}

.team-title{
  text-align:center;
  font-size:28px;
  margin-top:20px;
}

/* DASHBOARD */
.dashboard{
  margin-top:28px;
  background:rgba(0,0,0,0.25);
  border-radius:22px;
  padding:22px;
}
.dashboard-title{
  text-align:center;
  font-size:30px;
  margin-bottom:16px;
}
.dashboard table{
  width:100%;
  border-collapse:collapse;
}
.dashboard th,
.dashboard td{
  border:1px solid #FFD966;
  padding:14px;
  font-size:20px;
}
.dashboard th{
  background:rgba(255,217,102,0.15);
  text-align:center;
}

/* POPUP */
.popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:20;
}
.popup.show{display:flex}

.popup-content{
  background:#5c0a0a;
  padding:36px;
  border-radius:28px;
  width:90%;
  max-width:900px;
  text-align:center;
  position:relative;
}

.popup h2{
  font-size:36px;
  margin:0 0 10px;
}

.countdown{
  font-size:56px;
  margin:10px 0;
}

.member-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin:20px 0;
  text-align:left;
}
.member-grid.single{
  grid-template-columns:1fr;
}

.member{
  font-size:22px;
}

.result{
  font-size:36px;
  color:#b6ffcc;
  margin-top:18px;
}

.close-btn{
  margin-top:24px;
  padding:12px 26px;
  font-size:20px;
  border-radius:14px;
  background:#FFD966;
  border:none;
  cursor:pointer;
}

/* FIREWORK */
.firework{
  position:absolute;
  width:6px;
  height:6px;
  border-radius:50%;
  animation:explode 1s ease-out forwards;
}
@keyframes explode{
  to{
    transform:translate(var(--x),var(--y));
    opacity:0;
  }
}
</style>
</head>

<body>

<div class="card">
  <h1>CHUNG TAY H√ÅI L·ªòC</h1>

  <div class="control-bar">
    <select id="teamSelect">
      <option>ƒêang t·∫£i danh s√°ch b√†n...</option>
    </select>
    <button id="openBtn">M·ªû B√ÄN</button>
  </div>

  <div class="team-title" id="teamTitle">Ch∆∞a m·ªü b√†n</div>

  <!-- DASHBOARD -->
  <div class="dashboard">
    <div class="dashboard-title">üìä T·ªîNG K·∫æT TEAM L·ªòC</div>
    <table>
      <thead>
        <tr>
          <th>B√†n</th>
          <th>K·∫øt qu·∫£</th>
        </tr>
      </thead>
      <tbody id="dashboardBody"></tbody>
    </table>
  </div>
</div>

<!-- POPUP -->
<div class="popup" id="popup">
  <div class="popup-content">
    <h2>üçÄ TEAM L·ªòC üçÄ</h2>
    <div class="countdown" id="countdown">60</div>
    <div id="memberGrid" class="member-grid"></div>
    <div class="result" id="resultText"></div>
    <button class="close-btn" id="closePopup">ƒê√ìNG</button>
  </div>
</div>

<audio id="fireSound" src="https://assets.mixkit.co/sfx/preview/mixkit-fireworks-explosion-1703.mp3"></audio>

<script type="module">
import { db } from "./firebase.js";
import { ref, get, set, onValue } from
 "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const TIME_LIMIT = 60;

const teamSelect = document.getElementById("teamSelect");
const openBtn = document.getElementById("openBtn");
const teamTitle = document.getElementById("teamTitle");

const popup = document.getElementById("popup");
const countdownEl = document.getElementById("countdown");
const memberGrid = document.getElementById("memberGrid");
const resultText = document.getElementById("resultText");
const closePopup = document.getElementById("closePopup");
const fireSound = document.getElementById("fireSound");
const dashboardBody = document.getElementById("dashboardBody");

let activeTeamId = "";
let timer = null;
let revealed = false;

/* LOAD TEAMS (CONFIG + STATE) */
onValue(ref(db,"config/teams"), async snap=>{
  teamSelect.innerHTML="";
  const cfg = snap.val()||{};
  for(const [id,t] of Object.entries(cfg)){
    const stSnap = await get(ref(db,`teams/${id}/state`));
    const state = stSnap.val();
    const opt = document.createElement("option");
    opt.value = id;
    if(state==="revealed"){
      opt.text = `${t.name} (ƒê√É CH∆†I)`;
      opt.disabled = true;
    }else{
      opt.text = t.name;
    }
    teamSelect.appendChild(opt);
  }
});

/* OPEN TEAM */
openBtn.onclick = async ()=>{
  const teamId = teamSelect.value;
  const stateSnap = await get(ref(db,`teams/${teamId}/state`));
  if(stateSnap.val()==="revealed"){
    alert("B√†n n√†y ƒë√£ ch∆°i xong");
    return;
  }

  activeTeamId = teamId;
  revealed = false;

  const cfgSnap = await get(ref(db,`config/teams/${teamId}`));
  teamTitle.innerText = "ƒêang m·ªü: "+cfgSnap.val().name;

  await set(ref(db,"runtime/activeTableId"), teamId);
  await set(ref(db,`teams/${teamId}/state`),"enabled");
  await set(ref(db,`teams/${teamId}/total`), cfgSnap.val().defaultSize);

  popup.classList.add("show");
  startCountdown();
};

/* WATCH MEMBERS */
onValue(ref(db,"teams"), snap=>{
  if(!activeTeamId) return;
  const team = snap.val()?.[activeTeamId];
  if(!team) return;

  const members = team.members ? Object.values(team.members) : [];
  renderMembers(members);

  if(members.length >= team.total && !revealed){
    revealResult();
  }
});

/* COUNTDOWN */
function startCountdown(){
  let remain = TIME_LIMIT;
  countdownEl.innerText = remain;
  clearInterval(timer);
  timer = setInterval(()=>{
    remain--;
    countdownEl.innerText = remain;
    if(remain<=0 && !revealed){
      revealResult();
    }
  },1000);
}

/* REVEAL */
async function revealResult(){
  revealed = true;
  clearInterval(timer);

  const rewardSnap = await get(ref(db,"config/rewards"));
  const rewards = Object.values(rewardSnap.val()||{});
  const reward = rewards[Math.floor(Math.random()*rewards.length)];

  resultText.innerText = reward.title+" ‚Äì "+reward.content;
  fireSound.play();
  launchFirework();

  await set(ref(db,`teams/${activeTeamId}/state`),"revealed");
  await set(ref(db,`teams/${activeTeamId}/result`), reward);
  await set(ref(db,"runtime/activeTableId"), null);
}

/* DASHBOARD */
onValue(ref(db,"teams"), async snap=>{
  dashboardBody.innerHTML="";
  const teams = snap.val()||{};
  for(const [id,t] of Object.entries(teams)){
    if(t.state==="revealed" && t.result){
      const cfgSnap = await get(ref(db,`config/teams/${id}`));
      const name = cfgSnap.val()?.name || id;
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${name}</td><td>${t.result.title} ‚Äì ${t.result.content}</td>`;
      dashboardBody.appendChild(tr);
    }
  }
});

/* UI */
function renderMembers(list){
  memberGrid.innerHTML="";
  memberGrid.className="member-grid "+(list.length<=5?"single":"");
  list.forEach((m,i)=>{
    memberGrid.innerHTML+=`<div class="member">${i+1}. ${m}</div>`;
  });
}

function launchFirework(){
  for(let i=0;i<20;i++){
    const f=document.createElement("div");
    f.className="firework";
    f.style.background=`hsl(${Math.random()*360},100%,60%)`;
    f.style.left="50%";
    f.style.top="50%";
    f.style.setProperty("--x",(Math.random()*400-200)+"px");
    f.style.setProperty("--y",(Math.random()*400-200)+"px");
    popup.querySelector(".popup-content").appendChild(f);
    setTimeout(()=>f.remove(),1000);
  }
}

closePopup.onclick=()=>{
  popup.classList.remove("show");
};
</script>

</body>
</html>
